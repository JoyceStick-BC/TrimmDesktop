<!DOCTYPE html>
<html>
   <head>
      <meta charset = "UTF-8">
      <title>Home</title>
      <link rel="stylesheet" href="./css/index.css">
      <link href="https://fonts.googleapis.com/css?family=Roboto:200,300,400,500" rel="stylesheet">
      <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
   </head>

   <body>
      <div id="topBar">

      </div>
      <h2><b>Trimm Desktop</b></h2>
      <input type="checkbox" name="projectSelectorState" id="projectSelectorState">
      <div id="projectSelector">
          <h3 id="projectSelectorTitle">Select Project</h3>
          <label for="projectSelectorState">
              <div id="projectSelectorClose">
                  <p></p>
              </div>
          </label>
          <div id="savedProjects">

          </div>
          <button type="button" id="choose-file"><b>Add Project</b></button>
          <p id="file-input" style="display:none"></p>
          <!-- add stuff here -->
      </div>
      <label for="projectSelectorState">
          <div id="projectSelectorTrigger">
              <p id="current">No Project Selected</p>
          </div>
      </label>
      <div id="trimm-download">
          <div id="options" style="display:none">
              <p>Download All Project Assets:</p>
              <button type="button" name="button" id="trimm_pull">Trimm Pull</button>
              <p id="pull-progress"></p>
              <p>Download New Asset:</p>
              <input type="text" id="bundlename" placeholder="username/bundlename">
              <button type="button" name="button" id="trimm_install">Trimm Install</button>
              <div id="results">

	          </div>
              <p id="install-progress"></p>
          </div>
          <p>Upload Bundle (as joycestick)</p>
          <form id="upload-form" method="post" enctype="multipart/form-data">
              <input type="file" name="fileToUpload" value="" id="fileToUpload" class="inputFile">
              <label for="fileToUpload">Choose a file</label>
              <input type="submit" value="Upload Bundle" name="submit" id="submitFile">
              <label for="submitFile" id="upload-file-name"></label>
              <textarea name="description" rows="2" cols="42" id="description" placeholder="Bundle Description"></textarea>
          </form>
      </div>

      <div id="trimm-upload">

      </div>
   </body>
   <script type="text/javascript">
       var textEncoding = require('text-encoding');
       var TextDecoder = textEncoding.TextDecoder;
       let $ = require('jquery');
       var ipcRenderer = require('electron').ipcRenderer;

       var path = require("path");
       var fs = require("fs");
       var initPath = path.join('./', "init.json");
       var data;
       try {
           data = JSON.parse(fs.readFileSync(initPath, 'utf8'));
       }
       catch(e) {
           //create path?
       }

       currentProject = data['currentProject'];
       data = data['folders'];
       for(var project in data) {
           $('#savedProjects').html(
               $('#savedProjects').html() +
               "<button class='savedProject'" +
               "alt='" +
               project +
               "'>" +
               data[project] +
               "</button>"
           );
       }
       for (var current in currentProject) {
           $('#file-input').text(current);
           $('#current').html("<b>Currrent Project: " + currentProject[current] + "</b>");
           $('#options').css('display', 'block');
       }

       $('#trimm_pull').on('click', function() {
           //trimm pull
           var spawn = require('child_process').spawn;
           var py = spawn('python', ['./TrimmDesktop/trimm.py', 'pull', $('#file-input').text()]);
           py.stdout.on('data', function(data){
               var response = new TextDecoder("utf-8").decode(data);
               console.log(response);
           });
           py.stderr.on('data', function(data) {
                console.log(data.toString());
                $('#pull-progress').text("Pulling assets: " + data.toString());
           });
           py.stdout.on('end', function(data) {
               $('#pull-progress').text("Pulling assets: 100%");
           });
       });

       $('#upload-form').submit(function(event) {
           //submit form to Trimm3d for upload
           event.preventDefault();
           var file_data = $('#fileToUpload').prop('files')[0];
           var form_data = new FormData();
           form_data.append('description', $('#description').val())
           form_data.append('fileToUpload', file_data);
           form_data.append('username', 'joycestick');
           console.log(form_data);
           $.ajax({
                url: 'https://trimm3d.com/dashboard/upload',
                dataType: 'text',
                cache: false,
                contentType: false,
                processData: false,
                data: form_data,
                type: 'post',
                success: function(php_script_response){
                    console.log(JSON.parse(php_script_response));
                }
           });
       });

       $('#trimm_install').on('click', function() {
           //trimm install
           var spawn = require('child_process').spawn;
           var py = spawn('python', ['./TrimmDesktop/trimm.py', 'install', $('#file-input').text(), $('#bundlename').val()]);
           py.stdout.on('data', function(data){
               var response = new TextDecoder("utf-8").decode(data);
               console.log(response);
           });
           py.stderr.on('data', function(data) {
                console.error(data.toString());
                $('#install-progress').text("Downloading: " + data.toString());
            });
            py.stdout.on('end', function(data) {
                $('#install-progress').text("Downloading: 100%");
            });
       });

       $('#choose-file').on('click', function() {
           /*
            File Selector for project directory
           */
           //open file explorer
           const {dialog} = require('electron').remote;
           var filepath = dialog.showOpenDialog({properties: ['openFile', 'openDirectory', 'multiSelections']});
           //get filepath
           $('#file-input').text(filepath[0]);
           var projectName = filepath[0].split("/");
           var projectName = projectName[projectName.length - 1];
           //set appropriate html/css
           $('#current').html("<b>Currrent Project: " + projectName + "</b>");
           $('#options').css('display', 'block');
           $('#projectSelectorState').prop('checked', false);
           //update currentProject in init.JSON
           var initPath = path.join('./', "init.json");
           var data;
           try {
               data = JSON.parse(fs.readFileSync(initPath, 'utf8'));
           }
           catch(e) {
               //create path?
               console.log('failed');
           }
           data['folders'][filepath[0] + "/"] = projectName;
           console.log(data);
           fs.writeFile(initPath, JSON.stringify(data));
           //add folder to folder list
           $('#savedProjects').html(
               $('#savedProjects').html() +
               "<button class='savedProject'" +
               "alt='" +
               filepath[0] + "/" +
               "'>" +
               projectName +
               "</button>"
           );

       });

       $('.savedProject').on('click', function(event) {
           var filepath = $(event.target).closest('.savedProject').attr('alt');
           console.log(filepath);
           var projectName = $(event.target).closest('.savedProject').html();
           $('#file-input').text(filepath);
           $('#current').html("<b>Currrent Project: " + projectName + "</b>");
           $('#options').css('display', 'block');
           $('#projectSelectorState').prop('checked', false);
           //update currentProject in init.JSON
           var initPath = path.join('./', "init.json");
           var data;
           try {
               data = JSON.parse(fs.readFileSync(initPath, 'utf8'));
           }
           catch(e) {
               console.log('failed');
           }
           data['currentProject'] = { [filepath] : projectName };
           console.log(data);
           fs.writeFile(initPath, JSON.stringify(data));
       });

       $('#bundlename').on('input', function() {
           //make ajax request
			var val = $('#bundlename').val();
			if (val == "") {
				//if the input is empty, clear the results
				$('#results').html("");
				return;
			} else if (val.indexOf("/") != -1) {
                val = val.replace("/", " ");
            }
			//ajax request
			var results = $.ajax({
				type: "GET",
				dataType: 'text',
				url: 'https://trimm3d.com/api/browse/' + encodeURIComponent(val),
				success: function(data) {
					$('#results').html("");
					var result = (JSON.parse(data));
					for (var i = 0; i < result.length; i++) {
						var source = result[i]['_source'];
                        var bundle = source['user'] + "/" + source['bundleName'];
                        //updated result div
						$('#results').html(
							$('#results').html()
							+ "<div class='searchItem' alt='" + bundle + "'>"
							+ "<p>" + bundle + " | "
							+ source['description']
							+ "</p></div>"
						);
					}
				}
			});
       });

       $(document).ready(function() {
           $(document).on('click', '.searchItem', function(event) {
               var result = $(event.target).closest('.searchItem').attr('alt');
               $('#bundlename').val(result);
               $('#results').html("");
           });
       });

       $('#fileToUpload').on('change', function() {
          //handle file upload
          var filename = $('#fileToUpload').val().split('\\').pop();
          $('#upload-file-name').text(filename);
       });

       </script>
</html>
