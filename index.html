<!DOCTYPE html>
<html>
   <head>
      <meta charset = "UTF-8">
      <title>Home</title>
      <link rel="stylesheet" href="./css/index.css">
      <link href="https://fonts.googleapis.com/css?family=Roboto:200,300,400,500" rel="stylesheet">
   </head>

   <body>
      <h1>Trimm Desktop</h1>
      <div id="trimm-download">
          <p>Select project directory:</p>
          <p id="current"><b>No Current Directory Selected</b></p>
          <form action="index.html" id="form">
              <button type="button" id="choose-file">Select File</button>
              <p id="file-input" style="display:none"></p>
          </form>
          <div id="options" style="display:none">
              <p>Download All Project Assets:</p>
              <button type="button" name="button" id="trimm_pull">Trimm Pull</button>
              <p id="pull-progress"></p>
              <p>Download New Asset:</p>
              <input type="text" id="bundlename"placeholder="username/bundlename">
              <button type="button" name="button" id="trimm_install">Trimm Install</button>
              <p id="install-progress"></p>
          </div>
          <p>Upload Bundle (as joycestick)</p>
          <form id="upload-form" action="http://localhost/Trimm/public/dashboard/upload" method="post" enctype="multipart/form-data">
              <input type="file" name="fileToUpload" value="" id="test">
              <input type="submit" value="Upload Bundle" name="submit">
              <textarea name="description" rows="4" cols="50" id="description"></textarea>
              <input type="text" name="username" value="joycestick" style="display:none;">
          </form>
      </div>

      <div id="trimm-upload">

      </div>
   </body>
   <script type="text/javascript">
       var textEncoding = require('text-encoding');
       var TextDecoder = textEncoding.TextDecoder;
       let $ = require('jquery')
       $('#trimm_pull').on('click', function() {
           //trimm pull
           var spawn = require('child_process').spawn;
           var py = spawn('python', ['./Trimm-CLI-master/trimm.py', 'pull', $('#file-input').text()]);
           py.stdout.on('data', function(data){
               var response = new TextDecoder("utf-8").decode(data);
               console.log(response);
           });
           py.stderr.on('data', function(data) {
                console.log(data.toString());
                $('#pull-progress').text("Pulling assets: " + data.toString());
           });
           py.stdout.on('end', function(data) {
               $('#pull-progress').text("Pulling assets: 100%");
           });
       });

       $('#upload-form').submit(function() {
           event.preventDefault();
           var file_data = $('#test').prop('files')[0];
           var form_data = new FormData();
           console.log(form_data);
           form_data.append('description', $('#description').val())
           form_data.append('fileToUpload', file_data);
           form_data.append('username', 'joycestick')
           $.ajax({
                url: 'http://localhost/Trimm/public/dashboard/upload', // point to server-side PHP script
                dataType: 'text',  // what to expect back from the PHP script, if anything
                cache: false,
                contentType: false,
                processData: false,
                data: form_data,
                type: 'post',
                success: function(php_script_response){
                    console.log(php_script_response); // display response from the PHP script, if any
                }
           });
           console.log('done');
       })

       $('#trimm_install').on('click', function() {
           //trimm install
           var spawn = require('child_process').spawn;
           var py = spawn('python', ['./Trimm-CLI-master/trimm.py', 'install', $('#file-input').text(), $('#bundlename').val()]);
           py.stdout.on('data', function(data){
               var response = new TextDecoder("utf-8").decode(data);
               console.log(response);
           });
           py.stderr.on('data', function(data) {
                console.error(data.toString());
                $('#install-progress').text("Downloading: " + data.toString());
            });
            py.stdout.on('end', function(data) {
                $('#install-progress').text("Downloading: 100%");
            });
       });

       $('#choose-file').on('click', function() {
           const {dialog} = require('electron').remote;
           var filepath = dialog.showOpenDialog({properties: ['openFile', 'openDirectory', 'multiSelections']});
           $('#file-input').text(filepath[0] + "/");
           $('#current').html("<b>Currrent Directory: " + filepath[0] + "/</b>");
           $('#options').css('display', 'block');
       });
       </script>
</html>
